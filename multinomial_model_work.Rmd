---
title: "multinomial_model_work"
author: "Joseph Denby"
date: "11/12/2018"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
library(data.table)
library(tidyverse)
library(readr)
library(stringr)
library(DT)
library(tidytext)
library(RSQLite)
library(feather)
library(xlsx)
library(rstan)
library(zoo)
library(shinystan)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r read_liwc}
liwc <- read_tsv("word_lists/liwc2007_converted.tsv", col_names = FALSE) %>%
  rename(word = X1, category = X2)
```

```{r Double Counted LIWC Words}
multi_liwcs <- liwc %>% 
  group_by(word) %>%
  summarise(n = n()) %>%
  filter(n > 1)

liwc %>%
  filter(word %in% multi_liwcs$word) %>%
  distinct(word, category) %>%
  group_by(category) %>%
  summarise(n = n())

  distinct(word, category) %>%
  mutate(n=n()) %>% 
  filter(n>1) %>% 
  View()

```

```{r Load Data}
together_present <- read_feather('data/RECOUNT_together_present.feather')
```

```{r Optional Filtering - 1 LIWC CATEGORY}
### For one LIWC category model
together_present <- together_present %>% 
  mutate(not_ipron = article + certain + conj + discrep + excl + i + incl + negate + 
           preps + quant + tentat + we + you + null) %>% 
  select(session, subject, person, lag_ipron, ipron, not_ipron) %>% 
  filter(session %in% c(5,8),
         subject == 22,
         person == 'Child')

LiwcCounts <- together_present %>% 
  select(ipron, not_ipron) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  select(lag_ipron) %>% 
  as.matrix()

```

```{r Aggregate Stan Data (for one LIWC Category Model)}

liwc_markers <- names(together_present)[5]

NumMarkers <- length(liwc_markers)
MidAge <- median(unique(together_present$session))
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- together_present$session
StdDev <- 1

```


```{r Optional Filtering - 2 LIWC CATEGORY}
### For two LIWC category model
together_present <- together_present %>% 
  mutate(null = article + certain + conj + discrep + excl + i + incl + negate + 
           preps +  tentat + we + you + null) %>% 
  select(session, subject, person, lag_ipron, ipron, null, quant, lag_quant) %>% 
  filter(session == 5,
         subject == 22,
         person == 'Child')

LiwcCounts <- together_present %>% 
  select(ipron, quant, null) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  select(lag_ipron, lag_quant) %>% 
  as.matrix()

```


```{r Aggregate Stan Data (for two LIWC Category Model)}

liwc_markers <- names(together_present)[c(5,7)]
lag_markers <- names(together_present)[c(4,8)]

NumMarkers <- length(liwc_markers)
MidAge <- median(unique(together_present$session))
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- together_present$session
StdDev <- 1

```

```{r Optional Filtering - FULL LIWC MODEL}
together_present <- together_present %>%
  filter(session ==5,
         subject == 22,
         person == "Child")
```

```{r Aggregate Stan Data (for full LIWC Category Models)}
liwc_markers <- names(together_present)[18:31]
lag_markers <- names(together_present)[4:17]

LiwcCounts <- together_present %>% 
  ungroup() %>%
  select(one_of(liwc_markers), null) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  ungroup() %>% 
  select(one_of(lag_markers)) %>% 
  as.matrix()

NumMarkers <- length(liwc_markers)
MidAge <- median(together_present$session)
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- together_present$session
StdDev <- 1
```

```{r sanity checks}
model_data <- LiwcCounts %>% 
  as_data_frame() %>% 
  bind_cols(as_data_frame(LagCounts)) 


model <- glm(cbind(ipron, not_ipron) ~ log(lag_ipron+1), family = "binomial", data = model_data) 

predicted_data <- model_data %>%
  mutate(empirical_ratio = ipron/(ipron + not_ipron)) %>%
  mutate(predicted_ratio = inv.logit(predict(model)))

predicted_data %>%
  ungroup() %>%
  select(-ipron, -not_ipron) %>%
  gather(measure, value, empirical_ratio, predicted_ratio) %>%
  group_by(lag_ipron, measure) %>%
  summarise(value = mean(value), n= n()) %>%
  spread(measure, value)


# TODO Sanity check for age effect on alignment


```

```{r Fit No Age Multi Stan Model}
fit <- stan('stan_models/noage_multinomial_alignment.stan', chains =1)
```

```{r Fit Age Multi Stan Model}
fit <- stan('stan_models/multinomial_alignment.stan', chains = 1)
```

```{r View Stan Fit}
launch_shinystan(fit)
```

