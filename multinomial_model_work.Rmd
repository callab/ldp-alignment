---
title: "multinomial_model_work"
author: "Joseph Denby"
date: "11/12/2018"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
library(data.table)
library(tidyverse)
library(readr)
library(stringr)
library(DT)
library(tidytext)
library(RSQLite)
library(feather)
library(xlsx)
library(rstan)
library(magrittr)
library(zoo)
library(shinystan)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r read_liwc}
liwc <- read_tsv("word_lists/liwc2007_converted.tsv", col_names = FALSE) %>%
  rename(word = X1, category = X2)
```

```{r Double Counted LIWC Words}
multi_liwcs <- liwc %>% 
  group_by(word) %>%
  summarise(n = n()) %>%
  filter(n > 1)

liwc %>%
  filter(word %in% multi_liwcs$word) %>%
  distinct(word, category) %>%
  group_by(category) %>%
  summarise(n = n())

  distinct(word, category) %>%
  mutate(n=n()) %>% 
  filter(n>1) %>% 
  View()

```

```{r Load Data}
old_together_present <- read_feather('data/together_present.feather')
together_present<- read_feather('data/RECOUNT_together_present.feather')

# for vectorized stan model
together_present <- together_present %>% 
  mutate(lag_null = 0)
```

```{r Check Representation of Each Subject}
together_present %>% 
  group_by(subject) %>% 
  summarise(sessions = n_distinct(session)) %>% 
  View()

# Most have all sessions - going to pick 10 sessions as the min
model_subjs <- together_present %>% 
  group_by(subject) %>% 
  summarise(sessions = n_distinct(session)) %>% 
  filter(sessions >= 10) %$% 
  subject

model_together_present <- together_present %>% 
  filter(subject %in% model_subjs)
```

```{r Filtering / Preparing Data for Stan Model - SPLIT BY SUBJECT}
chosen_subject <- model_subjs[4]

small_together_present <- model_together_present %>% 
  filter(subject == chosen_subject)

liwc_markers <- names(small_together_present)[18:31]
lag_markers <- names(small_together_present)[4:17]

LiwcCounts <- small_together_present %>% 
  ungroup() %>%
  select(one_of(liwc_markers), null) %>% 
  as.matrix()

LagCounts <- small_together_present %>% 
  ungroup() %>% 
  select(one_of(lag_markers)) %>% 
  as.matrix()

NumMarkers <- length(liwc_markers)
MidAge <- median(unique(together_present$session))
NumSubPops <- length(unique(small_together_present$person))
NumObservations <- dim(small_together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(small_together_present$person)) # Child - 1, Parent - 2
SpeakerAge <- small_together_present$session
StdDev <- 1

fit <- stan('stan_models/multinomial_alignment.stan', chains = 1)

```


```{r Optional Filtering - VECTORIZED 1 LIWC CATEGORY}
### For one LIWC category model
together_present <- together_present %>% 
  mutate(not_ipron = article + certain + conj + discrep + excl + i + incl + negate + 
           preps + quant + tentat + we + you + null) %>% 
  select(session, subject, person, lag_ipron,lag_null, ipron, not_ipron) %>% 
  filter(session %in% c(4,8),
         subject == 22,
         person == 'Parent') 

LiwcCounts <- together_present %>% 
  select(ipron, not_ipron) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  select(lag_ipron, lag_null) %>% 
  as.matrix()

```


```{r Optional Filtering - 1 LIWC CATEGORY}
### For one LIWC category model
together_present <- together_present %>% 
  mutate(not_ipron = article + certain + conj + discrep + excl + i + incl + negate + 
           preps + quant + tentat + we + you + null) %>% 
  select(session, subject, person, lag_ipron, ipron, not_ipron) %>% 
  filter(session %in% c(4,8),
         subject == 22,
         person == 'Parent') 

LiwcCounts <- together_present %>% 
  select(ipron, not_ipron) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  select(lag_ipron) %>% 
  as.matrix()

```

```{r VECTORIZED Aggregate Stan Data (for one LIWC Category Model)}
liwc_markers <- names(together_present)[5]

NumMarkers <- length(liwc_markers)
MidAge <- rep(median(unique(together_present$session)), NumMarkers+1)
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- matrix(rep(together_present$session, NumMarkers+1), NumObservations, byrow = TRUE)
StdDev <- 1
```

```{r Aggregate Stan Data (for one LIWC Category Model)}

liwc_markers <- names(together_present)[5]

NumMarkers <- length(liwc_markers)
MidAge <- median(unique(together_present$session))
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- together_present$session
StdDev <- 1

```


```{r Optional Filtering - 2 LIWC CATEGORY}
### For two LIWC category model
together_present <- together_present %>% 
  mutate(null = article + certain + conj + discrep + excl + i + incl + negate + 
           preps +  tentat + we + you + null) %>% 
  select(session, subject, person, lag_ipron, ipron, null, quant, lag_quant) %>% 
  filter(session == 5,
         subject == 22,
         person == 'Child')

LiwcCounts <- together_present %>% 
  select(ipron, quant, null) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  select(lag_ipron, lag_quant) %>% 
  as.matrix()

```


```{r Aggregate Stan Data (for two LIWC Category Model)}

liwc_markers <- names(together_present)[c(5,7)]
lag_markers <- names(together_present)[c(4,8)]

NumMarkers <- length(liwc_markers)
MidAge <- median(unique(together_present$session))
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- together_present$session
StdDev <- 1

```

```{r Optional Filtering - FULL LIWC MODEL}
together_present <- together_present %>%
  filter(session %in% c(3,8),
         subject %in% c(22,25,30))
```

```{r VECTORIZED Aggregate Stan Data (for full LIWC Category Models)}
liwc_markers <- names(together_present)[18:31]
lag_markers <- names(together_present)[4:17]

LiwcCounts <- together_present %>% 
  ungroup() %>%
  select(one_of(liwc_markers), null) %>% 
  as.matrix()

LagCounts <- together_present %>% 
  ungroup() %>% 
  select(one_of(lag_markers), lag_null) %>% 
  as.matrix()

NumMarkers <- length(liwc_markers)
MidAge <- rep(median(unique(together_present$session)), NumMarkers+1)
NumSubPops <- length(unique(together_present$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present$person)) # Child - 1; Parent - 2
SpeakerAge <- matrix(rep(together_present$session, NumMarkers+1), NumObservations, byrow = TRUE)
StdDev <- 1
```


```{r Aggregate Stan Data (for full LIWC Category Models) - CHILD}
together_present.child <- together_present %>% 
  filter(person=='Child')


liwc_markers <- names(together_present.child)[18:31]
lag_markers <- names(together_present.child)[4:17]

LiwcCounts <- together_present.child %>% 
  ungroup() %>%
  select(one_of(liwc_markers), null) %>% 
  as.matrix()

LagCounts <- together_present.child %>% 
  ungroup() %>% 
  select(one_of(lag_markers), lag_null) %>% 
  as.matrix()

NumMarkers <- length(liwc_markers)
MidAge <- median(together_present.child$session)
NumSubPops <- length(unique(together_present.child$person))
NumObservations <- dim(together_present.child)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present.child$person)) # Child - 1
SpeakerAge <- together_present.child$session
StdDev <- 1
```

```{r Aggregate Stan Data (for full LIWC Category Models) - PARENT}
together_present.parent <- together_present %>% 
  filter(person=='Parent')

liwc_markers <- names(together_present)[18:31]
lag_markers <- names(together_present)[4:17]

LiwcCounts <- together_present.parent %>% 
  ungroup() %>%
  select(one_of(liwc_markers), null) %>% 
  as.matrix()

LagCounts <- together_present.parent %>% 
  ungroup() %>% 
  select(one_of(lag_markers), lag_null) %>% 
  as.matrix()

NumMarkers <- length(liwc_markers)
MidAge <- median(together_present.parent$session)
NumSubPops <- length(unique(together_present.parent$person))
NumObservations <- dim(together_present)[1]
SpeakerSubPop <- as.numeric(as.factor(together_present.parent$person)) # Parent - 1
SpeakerAge <- together_present.parent$session
StdDev <- 1
```


```{r sanity checks}
model_data <- LiwcCounts %>% 
  as_data_frame() %>% 
  bind_cols(as_data_frame(LagCounts)) %>%
  mutate(session = SpeakerAge)


model <- glm(cbind(ipron, not_ipron) ~ log(lag_ipron+1) * session,
             family = "binomial", data = model_data) 

predicted_data <- model_data %>%
  mutate(empirical_ratio = ipron/(ipron + not_ipron)) %>%
  mutate(predicted_ratio = inv.logit(predict(model)))

predicted_data %>%
  ungroup() %>%
  select(-ipron, -not_ipron) %>%
  gather(measure, value, empirical_ratio, predicted_ratio) %>%
  group_by(lag_ipron, measure) %>%
  summarise(value = mean(value), n= n()) %>%
  spread(measure, value)


# TODO Sanity check for age effect on alignment


```

```{r Fit No Age Multi Stan Model}
fit <- stan('stan_models/noage_multinomial_alignment.stan', chains =1)
```

```{r Fit Age Multi Stan Model}
fit <- stan('stan_models/multinomial_alignment.stan', chains = 1)
```

```{r Fit Vectorized Age Multi Stan Model}
fit <- stan('stan_models/vectorized_multinomial_alignment.stan', chains = 1)
```

```{r View Stan Fit}
launch_shinystan(fit)
```

```{r}
# saveRDS(fit, file = "subsetfullfit.rds")
fit <- readRDS('subsetfullfit.rds')
```

```{r Fit Extraction}
fit <- readRDS("stanfits/subj22fit.rds")


stan_names <- names(fit) %>%
  as_data_frame() %>%
  filter(!str_detect(value, "observation"),
         !str_detect(value, "Marker"),
         !str_detect(value, "mu"))

rstan::extract(fit, stan_names[[1]][1:10]) %>%
  bind_cols() %>%
  summarise_all(mean) %>%
  #mutate(id = 1:n()) %>%
  gather(measure, value) %>%
  filter(!str_detect(measure, "Marker")) %>% 
  View()
```

```{r}
lag_data <- together_present %>%
  select(-null, -lag_null) %>%
  mutate(row = 1:n()) %>%
  gather(liwc, count, -subject, -session, -person, -row) %>%
  separate(liwc, into = c("type", "liwc"), sep = "_", fill = "left") %>%
  mutate(type = if_else(is.na(type), "current", "lag")) %>%
  spread(type, count) %>%
  group_by(person, session, subject, row) %>%
  mutate(current = current/sum(current, na.rm = T),
         lag = lag/sum(lag, na.rm = T)) %>%
  group_by(person, session, subject, row, liwc)


lag_data %>%
  filter(subject == 22, session < 5) %>%
  lm(logit(current) ~ logit(lag) * liwc * person, data = .) %>%
  summary()
  

lag_data %>%
  filter(subject == 22, session < 5) %>%
  mutate(current = current > 0, lag = lag >0) %>%
  glm(current ~ lag * liwc * person, data = .) %>%
  summary()
  
  
  
  ggplot(aes(x = lag, y = current, color = person)) +
  geom_point(alpha = .01) + 
  facet_grid(person ~ session) +
  geom_smooth(se = F,method = "loess") +
  theme_classic() +
  geom_hline(aes(yintercept = 0), lty =2) + 
  theme(legend.position = "none")
  
  
```

