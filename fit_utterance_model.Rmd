---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(stringr)
library(rstan)
library(bayesplot)
library(tidyboot)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```


```{r}
LDP_DIR <- "~/Documents/LDP/ldp.db"

#LDP_DIR <- "~/ldp/data/ldp.db"

# Read in LDP data
ldp <- src_sqlite(LDP_DIR)

utterances <- tbl(ldp, "utterances") %>%
  select(subject, session, line, p_chat, c_chat) %>%
  filter(p_chat != "" | c_chat != "") %>%
  collect() %>%
  mutate(order = 1:n()) 


```

```{r}
# to enumerate parent IDs
parentIDs <- rbind(unique(utterances$subject),seq(1,length(unique(utterances$subject)))) %>% 
  t() %>%
  as.data.frame()
colnames(parentIDs) <- c('subject', 'subject_numeral')


all_utt_lengths <- utterances %>%
  left_join(parentIDs) %>%
  filter(!is.na(p_chat)) %>%
  select(session,p_chat,subject_numeral) %>%
  mutate(length = str_count(p_chat, " ")) %>%
  filter(length > 0) %>%
  group_by(session, subject_numeral) %>%
  summarise(length = mean(length)) %>%
  summarise(sem = sd(length)/sqrt(n()-1),
            mean = mean(length))
# mean and sd length per session per session per subject

indiv_slopes <- utterances %>%
  left_join(parentIDs) %>%
  filter(!is.na(p_chat)) %>%
  select(session,p_chat,subject_numeral) %>%
  mutate(length = str_count(p_chat, " ")) %>%
  filter(length > 0) %>%
  group_by(subject_numeral, session) %>%
  summarise(length = mean(length, na.rm = T)) %>%
  filter(!is.na(length)) %>%
  group_by(subject_numeral) %>%
  spread(session, length) %>%
  mutate(slope = `12` - `1`) %>%
  filter(!is.na(slope))
  
cor.test(indiv_slopes$slope, indiv_slopes$`1`)


ggplot(all_utt_lengths, aes(x = session, y =mean)) + 
  geom_pointrange(aes(ymin = mean - sem, ymax = mean +sem)) + 
  geom_line() + 
  theme(legend.position = "none")

# mean utterance length for parents across development

one_file_utts <- utterances %>%
  left_join(parentIDs) %>%
  filter(!is.na(p_chat) ) %>%
  select(session,p_chat,subject_numeral) %>%
  mutate(length = str_count(p_chat, " ")) %>%
  filter(length > 0) %>%
  filter(session == 5, subject_numeral %in% c(1,2,3,4))

hist(one_file_utts$length)

utt_parent <- one_file_utts$subject_numeral
numParents <- length(unique(utt_parent))
numLengths <- length(one_file_utts$length)
utt_length <- one_file_utts$length

fit <- stan(file = "utt_length.stan", chains = 1)

posterior <- as.matrix(fit)

 
plot_title <- ggtitle("Posterior distributions",
                      "with medians and 80% intervals")
mcmc_areas(posterior, 
           pars = c("mu_mean", "sigma_mean", "mu_sd", "sigma_sd"), 
           prob = 0.8) + plot_title


posterior2 <- extract(fit, inc_warmup = TRUE, permuted = FALSE)


color_scheme_set("mix-blue-pink")
p <- mcmc_trace(posterior2,  pars = c("mu_mean", "mu_p[1]",
                                      "mu_p[2]", "mu_p[3]", "mu_p[4]"),
                n_warmup = 300,
                facet_args = list(nrow = 2, labeller = label_parsed))
p + facet_text(size = 15)



color_scheme_set("mix-blue-pink")
p <- mcmc_trace(posterior2,  pars = c("mu_mean", "sigma_mean",
                                      "mu_sd", "sigma_sd"),
                n_warmup = 300,
                facet_args = list(nrow = 2, labeller = label_parsed))
p + facet_text(size = 15)


hypothetical <- rexp(10000, .25)


data_frame(x = seq(.1, 2.1, .1), 
           p =  sapply(x, function(x) {sum(dexp(lengths, x,  log = TRUE))}))


hist(hypothetical)

color_scheme_set("red")
ppc_dens_overlay(y = fit$length, 
                 yrep = posterior_predict(fit, draws = 50))

# fit logistic function to mean utterance length across development

# xmU <- drm(mean ~ session, data = all_utt_lengths, fct = L.3(), type = 'continuous')
# summary(mU)
# plot(mU, type = 'all')


vals <- extract(fit, pars = c("lp__", "mu_mean", "sigma_mean", "mu_p[1]")) %>%
  bind_rows() %>%
  arrange(desc(lp__))
```

```{r}
y <- as.matrix(read.table('https://raw.github.com/wiki/stan-dev/rstan/rats.txt', header = TRUE))
x <- c(8, 15, 22, 29, 36)
xbar <- mean(x)
N <- nrow(y)
T <- ncol(y)
rats_fit <- stan(file = 'https://raw.githubusercontent.com/stan-dev/example-models/master/bugs_examples/vol1/rats/rats.stan')
```

```{r}
eight <- stan(file = "8schools.stan")

```
