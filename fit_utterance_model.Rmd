---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
library(tidyverse)
library(stringr)
library(rstan)
library(bayesplot)
```


```{r}
LDP_DIR <- "~/Documents/LDP/ldp.db"
#LDP_DIR <- "~/ldp/data/ldp.db"

# Read in LDP data
ldp <- src_sqlite(LDP_DIR)

utterances <- tbl(ldp, "utterances") %>%
  select(subject, session, line, p_chat, c_chat) %>%
  filter(p_chat != "" | c_chat != "") %>%
  collect() %>%
  mutate(order = 1:n()) 


```

```{r}
parentIDs <- rbind(unique(utterances$subject),seq(1,length(unique(utterances$subject)))) %>% # to enumerate parent IDs
  t() %>%
  as.data.frame()
colnames(parentIDs) <- c('subject', 'subject_numeral')


one_file_utts <- utterances %>%
  left_join(parentIDs) %>%
  filter(!is.na(p_chat)) %>%
  select(session,p_chat,subject_numeral) %>%
  mutate(length = str_count(p_chat, " ")) %>%
  filter(session == 5, subject_numeral == 1)

hist(one_file_utts$length)

numParents <- length(one_file_utts$subject_numeral)
parents <- one_file_utts$subject_numeral
numLengths <- length(one_file_utts$length)
lengths <- one_file_utts$length

fit <- stan(file = "utt_length.stan")

posterior <- as.matrix(fit)

plot_title <- ggtitle("Posterior distributions",
                      "with medians and 80% intervals")
mcmc_areas(posterior, 
           pars = c("lambda"), 
           prob = 0.8) + plot_title


posterior2 <- extract(fit, inc_warmup = TRUE, permuted = FALSE)


color_scheme_set("mix-blue-pink")
p <- mcmc_trace(posterior2,  pars = c("lambda"), n_warmup = 300,
                facet_args = list(nrow = 2, labeller = label_parsed))
p + facet_text(size = 15)

hypothetical <- rexp(10000, .5)


data_frame(x = seq(.1, 2.1, .1), 
           p =  sapply(x, function(x) {sum(dexp(lengths, x,  log = TRUE))}))


hist(hypothetical)

color_scheme_set("red")
ppc_dens_overlay(y = fit$length, 
                 yrep = posterior_predict(fit, draws = 50))

```

```{r}
y <- as.matrix(read.table('https://raw.github.com/wiki/stan-dev/rstan/rats.txt', header = TRUE))
x <- c(8, 15, 22, 29, 36)
xbar <- mean(x)
N <- nrow(y)
T <- ncol(y)
rats_fit <- stan(file = 'https://raw.githubusercontent.com/stan-dev/example-models/master/bugs_examples/vol1/rats/rats.stan')
```

```{r}
eight <- stan(file = "8schools.stan")

```
